-- ===============================
-- ALL-IN-ONE DML (DDL과 정합)
-- ===============================

-- 0) 초기화: 자식 → 부모 순으로 삭제

INSERT INTO EMISSION_FACTORS (VEHICLE_TYPE, FUEL_TYPE, CO2_GPKM, IDLE_GPS, NOTE)
VALUES ('25톤 트랙터', '경유', 1250.5, 11.2, '컨테이너 트랙터 표준 배출계수 (2024년 기준 가상값)');

-- 2) VEHICLES
INSERT INTO VEHICLES (VEHICLE_ID, FACTOR_ID, VEHICLE_TYPE, MODEL_NAME, CAPACITY_KG) VALUES
('부산82가1234', (SELECT FACTOR_ID FROM EMISSION_FACTORS WHERE VEHICLE_TYPE = '25톤 트랙터'), 'TRACTOR', '현대 엑시언트', 25000.00);

INSERT INTO VEHICLES (VEHICLE_ID, FACTOR_ID, VEHICLE_TYPE, MODEL_NAME, CAPACITY_KG) VALUES
('인천88사5678', (SELECT FACTOR_ID FROM EMISSION_FACTORS WHERE VEHICLE_TYPE = '25톤 트랙터'), 'TRACTOR', '볼보 FH16', 25000.00);

-- 3) SECTORS
INSERT INTO SECTORS (SECTOR_ID, SECTOR_NAME, LATITUDE, LONGITUDE, PRIORITY) VALUES
('BUSAN_NEW_PORT', '부산신항', 35.0931, 128.8239, 2);

-- 4) RUNS
INSERT INTO RUNS (RUN_ID, RUN_DATE, DEPOT_LAT, DEPOT_LON, OPTIMIZATION_STATUS, NATURAL_LANGUAGE_INPUT) VALUES
('RUN_20251015_001', TO_DATE('2025-10-15', 'YYYY-MM-DD'), 35.940000, 126.680000, 'COMPLETED', '군산 CY에서 출발해서 부산신항에 컨테이너 1개 운송');

-- 5) JOBS + 6) RUN_SUMMARY + 7) ASSIGNMENTS (JOB_ID 반환 사용)
DECLARE
    v_job_id NUMBER;
BEGIN
    INSERT INTO JOBS (RUN_ID, SECTOR_ID, ADDRESS, LATITUDE, LONGITUDE, DEMAND_KG)
    VALUES ('RUN_20251015_001', 'BUSAN_NEW_PORT', '부산광역시 강서구 신항남로 367', 35.0931, 128.8239, 22000.00)
    RETURNING JOB_ID INTO v_job_id;

    INSERT INTO RUN_SUMMARY (RUN_ID, ROUTE_OPTION_NAME, TOTAL_DISTANCE_KM, TOTAL_CO2_G, TOTAL_TIME_MIN, LLM_EXPLANATION) VALUES
    ('RUN_20251015_001', '네이버 추천 경로', 290.1, 362770.05, 220, '통행량이 적고 운전이 편한 경로입니다.');

    INSERT INTO RUN_SUMMARY (RUN_ID, ROUTE_OPTION_NAME, TOTAL_DISTANCE_KM, TOTAL_CO2_G, TOTAL_TIME_MIN, LLM_EXPLANATION) VALUES
    ('RUN_20251015_001', '카카오 최단 경로', 285.5, 357015.25, 215, '거리가 가장 짧은 경로입니다.');

    INSERT INTO ASSIGNMENTS (RUN_ID, ROUTE_OPTION_NAME, VEHICLE_ID, STEP_ORDER, START_JOB_ID, END_JOB_ID, DISTANCE_KM, CO2_G, LOAD_KG, TIME_MIN, AVG_GRADIENT_PCT, CONGESTION_FACTOR) VALUES
    ('RUN_20251015_001', '네이버 추천 경로', '부산82가1234', 1, NULL, v_job_id, 290.1, 362770.05, 22000.00, 220, 0.50, 1.1);

    INSERT INTO ASSIGNMENTS (RUN_ID, ROUTE_OPTION_NAME, VEHICLE_ID, STEP_ORDER, START_JOB_ID, END_JOB_ID, DISTANCE_KM, CO2_G, LOAD_KG, TIME_MIN, AVG_GRADIENT_PCT, CONGESTION_FACTOR) VALUES
    ('RUN_20251015_001', '카카오 최단 경로', '부산82가1234', 1, NULL, v_job_id, 285.5, 357015.25, 22000.00, 215, 0.30, 1.12);
END;
/

-- 8) SETTINGS
MERGE INTO SETTINGS s USING dual ON (s.key = 'alpha_load')
WHEN NOT MATCHED THEN INSERT (key, value) VALUES ('alpha_load','0.10');

MERGE INTO SETTINGS s USING dual ON (s.key = 'beta_grade')
WHEN NOT MATCHED THEN INSERT (key, value) VALUES ('beta_grade','0.03');

MERGE INTO SETTINGS s USING dual ON (s.key = 'speed_idle_threshold')
WHEN NOT MATCHED THEN INSERT (key, value) VALUES ('speed_idle_threshold','15');

MERGE INTO SETTINGS s USING dual ON (s.key = 'grade_cap')
WHEN NOT MATCHED THEN INSERT (key, value) VALUES ('grade_cap','0.30');

-- 9) CONGESTION_INDEX
INSERT INTO CONGESTION_INDEX (COMPUTED_AT, HOUR_OF_DAY, TIME_FACTOR, IDLE_FACTOR) VALUES
(SYSTIMESTAMP, 8, 1.30, 0.10);

INSERT INTO CONGESTION_INDEX (COMPUTED_AT, HOUR_OF_DAY, TIME_FACTOR, IDLE_FACTOR) VALUES
(SYSTIMESTAMP, 18, 1.35, 0.12);

-- 10) ITS_TRAFFIC (CSV 헤더: linkId, roadName, speed_kmh, congestion_level, observed_at)
INSERT INTO ITS_TRAFFIC (LINK_ID, ROAD_NAME, SPEED_KMH, CONGESTION_LEVEL, OBSERVED_AT)
VALUES ('110000123', '서해안고속도로', 72.5, 'M', TO_TIMESTAMP('2025-10-15 08:10', 'YYYY-MM-DD HH24:MI'));

INSERT INTO ITS_TRAFFIC (LINK_ID, ROAD_NAME, SPEED_KMH, CONGESTION_LEVEL, OBSERVED_AT)
VALUES ('110000124', '서해안고속도로', 58.2, 'H', TO_TIMESTAMP('2025-10-15 18:05', 'YYYY-MM-DD HH24:MI'));

-- 11) WEATHER_FORECAST (CSV 헤더: baseDate, baseTime, category, fcstDate, fcstTime, fcstValue, nx, ny)
INSERT INTO WEATHER_FORECAST (BASE_DATE, BASE_TIME, CATEGORY, FCST_DATE, FCST_TIME, FCST_VALUE, NX, NY)
VALUES ('20251015', '0800', 'T1H', '20251015', '0900', '16', 55, 68);

INSERT INTO WEATHER_FORECAST (BASE_DATE, BASE_TIME, CATEGORY, FCST_DATE, FCST_TIME, FCST_VALUE, NX, NY)
VALUES ('20251015', '0800', 'RN1', '20251015', '0900', '0', 55, 68);

COMMIT;