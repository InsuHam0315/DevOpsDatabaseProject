/* =========================================================
   0) 기존 테이블 정리 (존재 시만) - FK 고려해서 자식→부모 순
   ========================================================= */

BEGIN EXECUTE IMMEDIATE 'DROP TABLE ASSIGNMENT_GRADIENTS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ASSIGNMENTS CASCADE CONSTRAINTS';          EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE RUN_SUMMARY CASCADE CONSTRAINTS';          EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE JOBS CASCADE CONSTRAINTS';                 EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE RUNS CASCADE CONSTRAINTS';                 EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE SECTORS CASCADE CONSTRAINTS';              EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE VEHICLES CASCADE CONSTRAINTS';             EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE EMISSION_FACTORS CASCADE CONSTRAINTS';     EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE SETTINGS CASCADE CONSTRAINTS';             EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE CONGESTION_INDEX CASCADE CONSTRAINTS';     EXCEPTION WHEN OTHERS THEN NULL; END;
/

/* =========================================================
   1) EMISSION_FACTORS — DML에 맞춰 FUEL_TYPE/IDLE_GPS/NOTE 추가
      DML이 FACTOR_ID를 넣지 않으므로 IDENTITY 사용
   ========================================================= */

CREATE TABLE EMISSION_FACTORS (
    FACTOR_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    VEHICLE_TYPE  VARCHAR2(50)   NOT NULL,
    FUEL_TYPE     VARCHAR2(30),
    CO2_GPKM      NUMBER(10,3)   NOT NULL,
    IDLE_GPS      NUMBER(10,3),            -- 공회전 g/min 가정
    NOTE          VARCHAR2(200)
);

CREATE UNIQUE INDEX UQ_EMISSION_FACTORS_TYPE ON EMISSION_FACTORS (VEHICLE_TYPE);

/* =========================================================
   2) VEHICLES — DML에 맞춰 VEHICLE_TYPE/MODEL_NAME 추가
      FACTOR_ID FK (NOT NULL), CAPACITY_KG 필수
   ========================================================= */

CREATE TABLE VEHICLES (
    VEHICLE_ID    VARCHAR2(50)  PRIMARY KEY,
    FACTOR_ID     NUMBER        NOT NULL,
    VEHICLE_TYPE  VARCHAR2(50),         -- DML에서 사용
    MODEL_NAME    VARCHAR2(100),        -- DML에서 사용
    CAPACITY_KG   NUMBER(10,2)  NOT NULL,
    CONSTRAINT FK_VEHICLE_FACTOR FOREIGN KEY (FACTOR_ID)
        REFERENCES EMISSION_FACTORS (FACTOR_ID)
);

CREATE INDEX IX_VEHICLES_FACTOR ON VEHICLES (FACTOR_ID);

/* =========================================================
   3) SECTORS — 프론트엔드 섹터 관리 API를 위한 테이블 추가
      섹터별 배송 지역 정보 (위치, 시간창, 우선순위)
   ========================================================= */

CREATE TABLE SECTORS (
    SECTOR_ID    VARCHAR2(50)  PRIMARY KEY,
    SECTOR_NAME  VARCHAR2(100) NOT NULL,
    LATITUDE     NUMBER(10,6)  NOT NULL,
    LONGITUDE    NUMBER(10,6)  NOT NULL,
    TW_START     TIMESTAMP,              -- 시간창 시작 (시간만 사용)
    TW_END       TIMESTAMP,              -- 시간창 종료 (시간만 사용)
    PRIORITY     NUMBER(1) DEFAULT 2,    -- 우선순위 (1:높음, 2:보통, 3:낮음)
    CREATED_AT   TIMESTAMP DEFAULT SYSTIMESTAMP,
    UPDATED_AT   TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE INDEX IX_SECTORS_LOCATION ON SECTORS (LATITUDE, LONGITUDE);

/* =========================================================
   4) RUNS — DML 컬럼만 필수로 반영
      RUN_DATE/DEPOT_LAT/DEPOT_LON/OPTIMIZATION_STATUS/NATURAL_LANGUAGE_INPUT
      (DML에서 VEHICLE_ID, DIST_KM 안 넣으므로 둘 다 NULL 허용)
   ========================================================= */

CREATE TABLE RUNS (
    RUN_ID                   VARCHAR2(50) PRIMARY KEY,
    RUN_DATE                 DATE         NOT NULL,
    DEPOT_LAT                NUMBER(10,6),
    DEPOT_LON                NUMBER(10,6),
    OPTIMIZATION_STATUS      VARCHAR2(20),
    NATURAL_LANGUAGE_INPUT   CLOB,
    VEHICLE_ID               VARCHAR2(50),         -- 선택 사용
    DIST_KM                  NUMBER(10,3),         -- 선택 사용
    CONSTRAINT FK_RUNS_VEHICLE FOREIGN KEY (VEHICLE_ID)
        REFERENCES VEHICLES (VEHICLE_ID)
);

CREATE INDEX IX_RUNS_DATE ON RUNS (RUN_DATE);
CREATE INDEX IX_RUNS_STATUS ON RUNS (OPTIMIZATION_STATUS);

/* =========================================================
   5) JOBS — DML에 맞춰 생성 + 프론트엔드용 컬럼 추가
      (RUN_ID FK + 기본 PK IDENTITY + TW_START/TW_END/PRIORITY 추가)
   ========================================================= */

CREATE TABLE JOBS (
    JOB_ID       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    RUN_ID       VARCHAR2(50) NOT NULL,
    SECTOR_ID    VARCHAR2(50),
    ADDRESS      VARCHAR2(200),
    LATITUDE     NUMBER(10,6),
    LONGITUDE    NUMBER(10,6),
    DEMAND_KG    NUMBER(10,2),
    TW_START     TIMESTAMP,              -- 프론트엔드용: 시간창 시작
    TW_END       TIMESTAMP,              -- 프론트엔드용: 시간창 종료
    PRIORITY     NUMBER(1) DEFAULT 2,    -- 프론트엔드용: 우선순위 (1:높음, 2:보통, 3:낮음)
    CONSTRAINT FK_JOBS_RUN FOREIGN KEY (RUN_ID) REFERENCES RUNS (RUN_ID),
    CONSTRAINT FK_JOBS_SECTOR FOREIGN KEY (SECTOR_ID) REFERENCES SECTORS (SECTOR_ID)
);

CREATE INDEX IX_JOBS_RUN ON JOBS (RUN_ID);
CREATE INDEX IX_JOBS_SECTOR ON JOBS (SECTOR_ID);
CREATE INDEX IX_JOBS_TW ON JOBS (TW_START, TW_END);

/* =========================================================
   6) RUN_SUMMARY — 시드가 SUMMARY_ID를 넣지 않으므로 IDENTITY
      ROUTE_OPTION_NAME/TOTAL_TIME_MIN/LLM_EXPLANATION/SAVING_PCT 추가
   ========================================================= */

CREATE TABLE RUN_SUMMARY (
    SUMMARY_ID          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    RUN_ID              VARCHAR2(50) NOT NULL,
    ROUTE_OPTION_NAME   VARCHAR2(100),
    TOTAL_DISTANCE_KM   NUMBER(10,3) NOT NULL,
    TOTAL_CO2_G         NUMBER(12,3) NOT NULL,
    TOTAL_TIME_MIN      NUMBER(10,2),
    SAVING_PCT          NUMBER(5,2),              -- 프론트엔드용: 절감율 (%)
    LLM_EXPLANATION     CLOB,
    CONSTRAINT FK_SUMMARY_RUN FOREIGN KEY (RUN_ID) REFERENCES RUNS (RUN_ID)
);

CREATE INDEX IX_RUN_SUMMARY_RUN ON RUN_SUMMARY (RUN_ID);

/* =========================================================
   7) ASSIGNMENTS — 시드가 ASSIGN_ID를 넣지 않으므로 IDENTITY
      DML 컬럼 전부 반영 (ROUTE_OPTION_NAME/STEP_ORDER/…)
   ========================================================= */

CREATE TABLE ASSIGNMENTS (
    ASSIGN_ID            NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    RUN_ID               VARCHAR2(50)  NOT NULL,
    ROUTE_OPTION_NAME    VARCHAR2(100),
    VEHICLE_ID           VARCHAR2(50)  NOT NULL,
    STEP_ORDER           NUMBER,
    START_JOB_ID         NUMBER,
    END_JOB_ID           NUMBER,
    DISTANCE_KM          NUMBER(10,3),
    CO2_G                NUMBER(12,5)  NOT NULL,
    LOAD_KG              NUMBER(10,2),
    TIME_MIN             NUMBER(10,2),
    AVG_GRADIENT_PCT     NUMBER(6,3),
    CONGESTION_FACTOR    NUMBER(6,3),
    CONSTRAINT FK_ASSIGN_RUN      FOREIGN KEY (RUN_ID)     REFERENCES RUNS (RUN_ID),
    CONSTRAINT FK_ASSIGN_VEHICLE  FOREIGN KEY (VEHICLE_ID) REFERENCES VEHICLES (VEHICLE_ID),
    CONSTRAINT FK_ASSIGN_STARTJOB FOREIGN KEY (START_JOB_ID) REFERENCES JOBS (JOB_ID),
    CONSTRAINT FK_ASSIGN_ENDJOB   FOREIGN KEY (END_JOB_ID)   REFERENCES JOBS (JOB_ID)
);

CREATE INDEX IX_ASSIGN_RUN ON ASSIGNMENTS (RUN_ID);
CREATE INDEX IX_ASSIGN_VEHICLE ON ASSIGNMENTS (VEHICLE_ID);

/* =========================================================
   8) ASSIGNMENT_GRADIENTS — DML 삽입은 없지만 삭제 스크립트에 있으므로 작성
      (ASSIGN_ID FK + 구간 상세)
   ========================================================= */

CREATE TABLE ASSIGNMENT_GRADIENTS (
    GRADIENT_ID    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ASSIGN_ID      NUMBER NOT NULL,
    SEGMENT_ORDER  NUMBER,
    START_KM       NUMBER(10,3),
    END_KM         NUMBER(10,3),
    AVG_GRADE_PCT  NUMBER(6,3),
    NOTE           VARCHAR2(200),
    CONSTRAINT FK_AG_ASSIGN FOREIGN KEY (ASSIGN_ID)
        REFERENCES ASSIGNMENTS (ASSIGN_ID)
);

CREATE INDEX IX_AG_ASSIGN ON ASSIGNMENT_GRADIENTS (ASSIGN_ID);

/* =========================================================
   9) SETTINGS — DML에서 MERGE 시 s.key 사용 → 컬럼명 KEY 유지
   ========================================================= */

CREATE TABLE SETTINGS (
    KEY    VARCHAR2(100) PRIMARY KEY,
    VALUE  VARCHAR2(200)
);

/* =========================================================
   10) CONGESTION_INDEX — DML과 동일 컬럼
   ========================================================= */

CREATE TABLE CONGESTION_INDEX (
    COMPUTED_AT TIMESTAMP      NOT NULL,
    HOUR_OF_DAY NUMBER(2)      NOT NULL,
    TIME_FACTOR NUMBER(6,3)    NOT NULL,
    IDLE_FACTOR NUMBER(6,3)    NOT NULL
);

CREATE INDEX IX_CONGESTION_HOUR ON CONGESTION_INDEX (HOUR_OF_DAY);

